name: Preview Checks
on: [pull_request]
jobs:
  smoke:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: '20' }
      - run: npm ci || true
      - name: Wait for Vercel preview URL
        uses: patrickedqvist/wait-for-vercel-preview@v1.3.4
        id: vercel
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          max_timeout: 600
      - name: Smoke tests
        run: |
          sudo apt-get update && sudo apt-get install -y jq
          bash scripts/smoke.sh "${{ steps.vercel.outputs.url }}"
  e2e:
    runs-on: ubuntu-latest
    needs: smoke
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: '20' }
      - run: npm i -D playwright @playwright/test
      - run: npx playwright install --with-deps
      - name: Run E2E against preview
        env:
          BASE_URL: ${{ needs.smoke.outputs.url }}
        run: npx playwright test
