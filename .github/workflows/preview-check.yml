name: Preview Checks
on:
  pull_request:
jobs:
  smoke:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Wait for Vercel preview URL
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.pull_request.body || '';
            const match = body.match(/https?:\/\/[^ \n]*-vercel\.app/);
            if (!match) core.setFailed('No preview URL found in PR body/comments');
            core.exportVariable('PREVIEW_URL', match ? match[0] : '');
      - name: Hit health endpoints
        run: |
          set -e
          echo "Preview: $PREVIEW_URL"
          curl -fsS "$PREVIEW_URL/api/hello"
          curl -fsS "$PREVIEW_URL/api/rpa/health"
          curl -fsS "$PREVIEW_URL/api/rpa/diag"
