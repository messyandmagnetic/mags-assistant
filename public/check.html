<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>System Check</title>
  <link rel="stylesheet" href="/brand.css">
  <style>
    table { border-collapse: collapse; width: 100%; max-width: 500px; }
    td, th { border: 1px solid #ccc; padding: 6px; }
    .ok { background: #c7f5d9; }
    .fail { background: #f5c7c7; }
  </style>
</head>
<body>
  <div class="container">
    <h1>System Check</h1>
    <div>
      <button id="btn-sync">Sync</button>
      <button id="btn-audit">Audit</button>
    </div>
    <table id="status">
      <thead>
        <tr><th>Check</th><th>Status</th><th>Message</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
<script>
const FETCH_PASS = typeof NEXT_PUBLIC_FETCH_PASS === 'string' ? NEXT_PUBLIC_FETCH_PASS : '';
const WORKER = 'https://tight-snow-2840.messyandmagnetic.workers.dev';
const VER = 'https://mags-assistant.vercel.app';
const CHECKS = [
  {name: 'Vercel Health', method:'GET', url: `${VER}/api/health`},
  {name: 'Worker Health', method:'GET', url: `${WORKER}/health`},
  {name: 'Land Scan', method:'POST', url: `${WORKER}/land/scan`},
  {name: 'Land Summary', method:'POST', url: `${WORKER}/land/summary`},
];
function hdrs(){const h={'Content-Type':'application/json'};if(FETCH_PASS)h['X-Fetch-Pass']=FETCH_PASS;return h;}
async function runChecks(){
  const tbody=document.querySelector('#status tbody');
  tbody.innerHTML='';
  for(const c of CHECKS){
    const row=document.createElement('tr');
    row.innerHTML=`<td>${c.name}</td><td>...</td><td></td>`;
    tbody.appendChild(row);
    try{
      const r=await fetch(c.url,{method:c.method,headers:hdrs(),body:c.method==='POST'?"{}":undefined});
      const text=await r.text();
      const ok=r.ok;
      row.cells[1].textContent=ok?'ok':'fail';
      row.cells[1].className=ok?'ok':'fail';
      row.cells[2].textContent=text.slice(0,80);
    }catch(e){
      row.cells[1].textContent='fail';
      row.cells[1].className='fail';
      row.cells[2].textContent=e.message;
    }
  }
}
runChecks();

document.getElementById('btn-sync').addEventListener('click',()=>{
  fetch(`${WORKER}/land/scan`,{method:'POST',headers:hdrs(),body:'{}'}).then(r=>r.text()).then(t=>alert(t)).catch(e=>alert(e));
});
document.getElementById('btn-audit').addEventListener('click',()=>{
  fetch(`${WORKER}/land/summary`,{method:'POST',headers:hdrs(),body:'{}'}).then(r=>r.text()).then(t=>alert(t)).catch(e=>alert(e));
});
</script>
</body>
</html>
