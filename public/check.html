<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Mags Check Panel</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font: 16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; padding: 20px; max-width: 760px; margin: auto; }
    h1 { margin: 0 0 12px; }
    .row { margin: 12px 0; display:flex; gap:12px; align-items:center; flex-wrap: wrap; }
    button { padding:10px 14px; cursor:pointer; }
    .ok { color: #0a0; } .bad { color:#b00; } .muted { color:#666; }
    ul { padding-left: 20px; }
    code { background: #f5f5f5; padding:2px 6px; border-radius:4px;}
  </style>
</head>
<body>
  <h1>Mags – Check Panel</h1>

  <h3>Endpoints</h3>
  <ul id="ep-list" class="muted"></ul>

  <h3>Actions</h3>
  <div class="row">
    <button id="btn-sync">Sync Stripe → Notion</button>
    <span id="sync-status" class="muted">idle</span>
  </div>
  <div class="row">
    <button id="btn-audit">Run Price Audit</button>
    <span id="audit-status" class="muted">idle</span>
  </div>

  <script>
    const WORKER = 'https://tight-snow-2840.messyandmagnetic.workers.dev';
    const FETCH_PASS = localStorage.getItem('fetch_pass') || ''; // you can set via devtools: localStorage.setItem('fetch_pass', 'yourpass')

    // Health endpoints to probe (GET)
    const endpoints = [
      { name: 'vercel /api/health', url: '/api/health' },
      { name: 'worker /api/health', url: WORKER + '/api/health' },
    ];

    function li(text, ok) {
      const el = document.createElement('li');
      el.textContent = text;
      el.className = ok ? 'ok' : 'bad';
      return el;
    }

    async function probeAll() {
      const ul = document.getElementById('ep-list');
      ul.innerHTML = '';
      for (const ep of endpoints) {
        const item = document.createElement('li');
        item.textContent = ep.name + ' …';
        ul.appendChild(item);
        try {
          const r = await fetch(ep.url);
          const ok = r.ok;
          item.textContent = ep.name + ': ' + (ok ? 'OK' : 'FAIL ' + r.status);
          item.className = ok ? 'ok' : 'bad';
        } catch (e) {
          item.textContent = ep.name + ': ERR';
          item.className = 'bad';
        }
      }
    }

    function setStatus(id, ok, msg) {
      const el = document.getElementById(id);
      el.textContent = msg;
      el.className = ok ? 'ok' : 'bad';
    }

    async function postJSON(url) {
      const headers = { 'Content-Type': 'application/json' };
      if (FETCH_PASS) headers['X-Fetch-Pass'] = FETCH_PASS;
      const r = await fetch(url, { method: 'POST', headers });
      const js = await r.json().catch(() => ({}));
      return { ok: r.ok, data: js };
    }

    document.getElementById('btn-sync').addEventListener('click', async () => {
      setStatus('sync-status', true, 'running…');
      const res = await postJSON(WORKER + '/api/stripe/sync-products');
      setStatus('sync-status', res.ok, res.ok ? 'synced' : ('failed: ' + (res.data && res.data.error || '')));
    });

    document.getElementById('btn-audit').addEventListener('click', async () => {
      setStatus('audit-status', true, 'running…');
      const res = await postJSON(WORKER + '/api/stripe/price-audit');
      setStatus('audit-status', res.ok, res.ok ? 'audited' : ('failed: ' + (res.data && res.data.error || '')));
    });

    probeAll();
  </script>
</body>
</html>
