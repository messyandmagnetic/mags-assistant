<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>System Check</title>
  <link rel="stylesheet" href="/brand.css">
</head>
<body>
  <div class="container">
    <h1>System Check</h1>
    <div id="cards"></div>
    <button id="btn-digest">Send test digest</button>
  </div>
<script>
const CARDS=[
  {name:'API Health',url:'/api/diag/health'},
  {name:'Notion',url:'/api/diag/notion'},
  {name:'Stripe',url:'https://tight-snow-2840.messyandmagnetic.workers.dev/health',dash:'https://dashboard.stripe.com/test/webhooks'},
  {name:'Gmail',url:'/api/diag/gmail'},
  {name:'Telegram',url:'/api/diag/telegram'},
  {name:'Drive',url:'/api/diag/drive'},
  {name:'Cron',url:'/api/diag/cron'}
];
async function run(){
  const host=document.getElementById('cards');
  for(const c of CARDS){
    const div=document.createElement('div');
    div.className='card';
    div.textContent=c.name+': checking...';
    host.appendChild(div);
    try{
      const r=await fetch(c.url);
      const j=await r.json();
      if(j.ok){
        div.classList.add('ok');
        div.textContent=c.name;
        if(c.dash){
          const a=document.createElement('a');
          a.href=c.dash;
          a.target='_blank';
          a.textContent='Send Stripe Test (dashboard)';
          a.className='btn';
          div.appendChild(a);
        }
      }else{
        div.classList.add('fail');
        div.textContent=c.name+': '+(j.reason||'error');
        if(j.next_steps&&j.next_steps[0]){
          const ns=document.createElement('div');
          ns.className='next';
          ns.textContent=j.next_steps[0];
          div.appendChild(ns);
        }
      }
    }catch(e){
      div.classList.add('fail');
      div.textContent=c.name+': network error';
    }
  }
}
run();
document.getElementById('btn-digest').addEventListener('click',()=>{
  fetch('/api/cron/digest?test=true', {method:'POST'});
});
</script>
<style>
  .card{padding:10px;margin:6px;border:1px solid #ccc;}
  .card.ok{background:#c7f5d9;}
  .card.fail{background:#f5c7c7;}
  .next{font-size:0.9em;margin-top:4px;}
  .btn{margin-left:8px;font-size:0.9em;}
</style>
</body>
</html>
